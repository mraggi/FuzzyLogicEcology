cmake_minimum_required(VERSION 2.6)
project(fuzzylogic)

set(CMAKE_BUILD_TYPE Release)
add_definitions(-std=c++14 -O3 -march=native)

configure_file(${CMAKE_CURRENT_SOURCE_DIR}/QuercusOaxaca.txt ${CMAKE_CURRENT_BINARY_DIR}/QuercusOaxaca.txt COPYONLY)
configure_file(${CMAKE_CURRENT_SOURCE_DIR}/quercus_build_graph.sh ${CMAKE_CURRENT_BINARY_DIR}/quercus_build_graph.sh COPYONLY)
configure_file(${CMAKE_CURRENT_SOURCE_DIR}/lobatae.txt ${CMAKE_CURRENT_BINARY_DIR}/lobatae.txt COPYONLY)
configure_file(${CMAKE_CURRENT_SOURCE_DIR}/lobatae_build_graph.sh ${CMAKE_CURRENT_BINARY_DIR}/lobatae_build_graph.sh COPYONLY)
configure_file(${CMAKE_CURRENT_SOURCE_DIR}/redes_centro.txt ${CMAKE_CURRENT_BINARY_DIR}/redes_centro.txt COPYONLY)
configure_file(${CMAKE_CURRENT_SOURCE_DIR}/centro_build_graph.sh ${CMAKE_CURRENT_BINARY_DIR}/centro_build_graph.sh COPYONLY)

configure_file(${CMAKE_CURRENT_SOURCE_DIR}/analyze_graph.sage ${CMAKE_CURRENT_BINARY_DIR}/analyze_graph.sage COPYONLY)

# add_subdirectory(Graph)
# include_directories(Graph)

set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} "${CMAKE_SOURCE_DIR}/cmake_modules")
message("Cmake modules in " ${CMAKE_MODULE_PATH})
find_package(ArrayFire)
find_package(CUDA) 
find_package(NVVM)
find_package(OpenCL)
# find_package(Eigen3)
find_package(BLAZE)
find_package(OpenMP)
if (OPENMP_FOUND)
	set (CMAKE_C_FLAGS "${CMAKE_C_FLAGS} ${OpenMP_C_FLAGS}")
	set (CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} ${OpenMP_CXX_FLAGS}")
	add_definitions(-DUSE_OPENMP)
endif()

find_package(Boost COMPONENTS program_options REQUIRED)

include_directories(${Boost_INCLUDE_DIRS})

set(EXTRA_LIBS ${Boost_LIBRARIES}  ${CMAKE_THREAD_LIBS_INIT})
message("Extra libs: " ${EXTRA_LIBS})

if (BLAZE_FOUND)
	message("Blaze Library found at " ${BLAZE_INCLUDE_DIR})
	include_directories(${BLAZE_INCLUDE_DIR})
elseif (EIGEN3_FOUND)
	message("Eigen Library found at " ${EIGEN3_INCLUDE_DIR})
	include_directories(${EIGEN3_INCLUDE_DIR})
elseif (ArrayFire_CUDA_FOUND)
	include_directories(${ArrayFire_INCLUDE_DIRS})
	message("arrayfire cuda found at " ${ArrayFire_INCLUDE_DIRS})
	add_definitions(-DUSE_GPU)
	set(EXTRA_LIBS ${EXTRA_LIBS} ${ArrayFire_CUDA_LIBRARIES} ${CUDA_LIBRARIES} ${NVVM_LIB})
elseif(ArrayFire_OpenCL_FOUND)
	include_directories(${ArrayFire_INCLUDE_DIRS})
	message("arrayfire OpenCL found at "  ${ArrayFire_INCLUDE_DIRS})
	add_definitions(-DUSE_GPU)
	set(EXTRA_LIBS ${EXTRA_LIBS} ${ArrayFire_OpenCL_LIBRARIES} ${OpenCL_LIBRARIES})
else()
	message("Neither eigen nor blaze nor arrayfire library found! Using old version!")
endif()

set(MYSOURCES main.cpp Point.cpp ReadFile.cpp argumentparser.cpp)

if (BLAZE_FOUND)
	set(MYSOURCES ${MYSOURCES} GraphCalculator_Blaze.cpp)		
elseif (EIGEN3_FOUND)
	set(MYSOURCES ${MYSOURCES} GraphCalculator_Eigen.cpp)		
elseif (ArrayFire_CUDA_FOUND OR ArrayFire_OpenCL_FOUND)
	set(MYSOURCES ${MYSOURCES} GraphCalculator_GPU.cpp)
else()
	set(MYSOURCES ${MYSOURCES} Mu.cpp GraphCalculator.cpp)
endif()

add_executable(fuzzylogic ${MYSOURCES})

target_link_libraries(fuzzylogic ${EXTRA_LIBS})
